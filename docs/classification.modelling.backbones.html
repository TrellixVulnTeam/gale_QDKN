---

title: Backbones 


keywords: fastai
sidebar: home_sidebar

summary: "Backbones/feature extractors for use in Image Classification Tasks"
description: "Backbones/feature extractors for use in Image Classification Tasks"
nb_path: "nbs/04_classification.modelling.backbones.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04_classification.modelling.backbones.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="6b789e1b-ad5b-43a9-855f-7e359043bfae"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6b789e1b-ad5b-43a9-855f-7e359043bfae');

            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_BACKBONES\"]";
                var nbb_formatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_BACKBONES\"]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">MISSING</span><span class="p">,</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">OmegaConf</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="224fb5ed-fb4f-41d1-9af3-996d606f89a4"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#224fb5ed-fb4f-41d1-9af3-996d606f89a4');

            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "import copy\nfrom dataclasses import dataclass, field\n\nfrom fastcore.test import *\nfrom omegaconf import MISSING, DictConfig, OmegaConf";
                var nbb_formatted_code = "import copy\nfrom dataclasses import dataclass, field\n\nfrom fastcore.test import *\nfrom omegaconf import MISSING, DictConfig, OmegaConf";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="has_pool_type" class="doc_header"><code>has_pool_type</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>has_pool_type</code>(<strong><code>m</code></strong>:<code>Module</code>)</p>
</blockquote>
<p>Return <code>True</code> if <code>m</code> is a pooling layer or has one in its children</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="684833ec-8cf0-46ab-9ca8-a3afa5ccf75c"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#684833ec-8cf0-46ab-9ca8-a3afa5ccf75c');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "# export\n# funtions taken from: https://github.com/fastai/fastai/blob/master/fastai/vision/learner.py#L76\ndef _is_pool_type(l: nn.Module):\n    return re.search(r\"Pool[123]d$\", l.__class__.__name__)\n\n\ndef has_pool_type(m: nn.Module):\n    \"Return `True` if `m` is a pooling layer or has one in its children\"\n    if _is_pool_type(m):\n        return True\n    for l in m.children():\n        if has_pool_type(l):\n            return True\n    return False";
                var nbb_formatted_code = "# export\n# funtions taken from: https://github.com/fastai/fastai/blob/master/fastai/vision/learner.py#L76\ndef _is_pool_type(l: nn.Module):\n    return re.search(r\"Pool[123]d$\", l.__class__.__name__)\n\n\ndef has_pool_type(m: nn.Module):\n    \"Return `True` if `m` is a pooling layer or has one in its children\"\n    if _is_pool_type(m):\n        return True\n    for l in m.children():\n        if has_pool_type(l):\n            return True\n    return False";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="prepare_backbone" class="doc_header"><code>prepare_backbone</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L45" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>prepare_backbone</code>(<strong><code>model</code></strong>:<code>Module</code>, <strong><code>cut</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Cut off the body of a typically pretrained <code>model</code> as determined by <code>cut</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="40898b90-a89f-4ed7-b268-d9350465996f"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#40898b90-a89f-4ed7-b268-d9350465996f');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "# export\ndef prepare_backbone(model: nn.Module, cut=None):\n    \"Cut off the body of a typically pretrained `model` as determined by `cut`\"\n    if cut is None:\n        ll = list(enumerate(model.children()))\n        cut = next(i for i, o in reversed(ll) if has_pool_type(o))\n    if isinstance(cut, int):\n        return nn.Sequential(*list(model.children())[:cut])\n    elif callable(cut):\n        return cut(model)\n    else:\n        raise NamedError(\"cut must be either integer or a function\")";
                var nbb_formatted_code = "# export\ndef prepare_backbone(model: nn.Module, cut=None):\n    \"Cut off the body of a typically pretrained `model` as determined by `cut`\"\n    if cut is None:\n        ll = list(enumerate(model.children()))\n        cut = next(i for i, o in reversed(ll) if has_pool_type(o))\n    if isinstance(cut, int):\n        return nn.Sequential(*list(model.children())[:cut])\n    elif callable(cut):\n        return cut(model)\n    else:\n        raise NamedError(\"cut must be either integer or a function\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1"># fmt: on</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">prepare_backbone</span><span class="p">(</span><span class="n">tst</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">prepare_backbone</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">prepare_backbone</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="n">cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="0ce3ac87-1ff4-4259-93f0-36c834aaf8fd"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#0ce3ac87-1ff4-4259-93f0-36c834aaf8fd');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "# fmt: off\ntst = nn.Sequential(nn.Conv2d(3, 5, 3), nn.BatchNorm2d(5), nn.AvgPool2d(1), nn.Linear(3, 4))\n# fmt: on\n\nm = prepare_backbone(tst)\ntest_eq(len(m), 2)\n\nm = prepare_backbone(tst, cut=3)\ntest_eq(len(m), 3)\n\nm = prepare_backbone(tst, cut=-1)\ntest_eq(len(m), 3)";
                var nbb_formatted_code = "# fmt: off\ntst = nn.Sequential(nn.Conv2d(3, 5, 3), nn.BatchNorm2d(5), nn.AvgPool2d(1), nn.Linear(3, 4))\n# fmt: on\n\nm = prepare_backbone(tst)\ntest_eq(len(m), 2)\n\nm = prepare_backbone(tst, cut=3)\ntest_eq(len(m), 3)\n\nm = prepare_backbone(tst, cut=-1)\ntest_eq(len(m), 3)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="filter_weight_decay" class="doc_header"><code>filter_weight_decay</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>filter_weight_decay</code>(<strong><code>model</code></strong>:<code>Module</code>, <strong><code>lr</code></strong>:<code>float</code>, <strong><code>weight_decay</code></strong>:<code>float</code>=<em><code>1e-05</code></em>, <strong><code>skip_list</code></strong>=<em><code>()</code></em>)</p>
</blockquote>
<p>Filter out bias, bn and other 1d params from weight decay.
Modified from: <a href="https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/optim/optim_factory.py">timm</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="13ac0b63-56e9-447e-8a1a-46ae2e5b8242"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#13ac0b63-56e9-447e-8a1a-46ae2e5b8242');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "# export\ndef filter_weight_decay(\n    model: nn.Module,\n    lr: float,\n    weight_decay: float = 1e-5,\n    skip_list=(),\n) -> List[Dict]:\n    \"\"\"\n    Filter out bias, bn and other 1d params from weight decay.\n    Modified from: [timm](https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/optim/optim_factory.py)\n    \"\"\"\n    decay = []\n    no_decay = []\n    for name, param in model.named_parameters():\n        if not param.requires_grad:\n            continue  # frozen weights\n        if len(param.shape) == 1 or name.endswith(\".bias\") or name in skip_list:\n            no_decay.append(param)\n        else:\n            decay.append(param)\n    return [\n        {\"params\": no_decay, \"weight_decay\": 0.0, \"lr\": lr},\n        {\"params\": decay, \"weight_decay\": weight_decay, \"lr\": lr},\n    ]";
                var nbb_formatted_code = "# export\ndef filter_weight_decay(\n    model: nn.Module,\n    lr: float,\n    weight_decay: float = 1e-5,\n    skip_list=(),\n) -> List[Dict]:\n    \"\"\"\n    Filter out bias, bn and other 1d params from weight decay.\n    Modified from: [timm](https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/optim/optim_factory.py)\n    \"\"\"\n    decay = []\n    no_decay = []\n    for name, param in model.named_parameters():\n        if not param.requires_grad:\n            continue  # frozen weights\n        if len(param.shape) == 1 or name.endswith(\".bias\") or name in skip_list:\n            no_decay.append(param)\n        else:\n            decay.append(param)\n    return [\n        {\"params\": no_decay, \"weight_decay\": 0.0, \"lr\": lr},\n        {\"params\": decay, \"weight_decay\": weight_decay, \"lr\": lr},\n    ]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="6413bc04-e198-4d9f-8928-db6e171628a9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6413bc04-e198-4d9f-8928-db6e171628a9');

            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "# export\nclass ImageClassificationBackbone(GaleModule, metaclass=abc.ABCMeta):\n    \"\"\"\n    Abstract class for ImageClassification BackBones\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"\n        The `__init__` method of any subclass can specify its own set of arguments.\n        \"\"\"\n        super().__init__()\n\n    def get_lrs(self) -> List:\n        \"\"\"\n        Returns a List containining the Lrs' for\n        each parameter group. This is required to build schedulers\n        like `torch.optim.lr_scheduler.OneCycleScheduler` which needs\n        the max lrs' for all the Param Groups.\n        \"\"\"\n        lrs = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n        return lrs\n\n    @abc.abstractmethod\n    def output_shape(self) -> ShapeSpec:\n        \"\"\"\n        Returns the output shape. For most backbones\n        this means it will contain the channels in the\n        output layer.\n        \"\"\"\n        pass";
                var nbb_formatted_code = "# export\nclass ImageClassificationBackbone(GaleModule, metaclass=abc.ABCMeta):\n    \"\"\"\n    Abstract class for ImageClassification BackBones\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"\n        The `__init__` method of any subclass can specify its own set of arguments.\n        \"\"\"\n        super().__init__()\n\n    def get_lrs(self) -> List:\n        \"\"\"\n        Returns a List containining the Lrs' for\n        each parameter group. This is required to build schedulers\n        like `torch.optim.lr_scheduler.OneCycleScheduler` which needs\n        the max lrs' for all the Param Groups.\n        \"\"\"\n        lrs = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n        return lrs\n\n    @abc.abstractmethod\n    def output_shape(self) -> ShapeSpec:\n        \"\"\"\n        Returns the output shape. For most backbones\n        this means it will contain the channels in the\n        output layer.\n        \"\"\"\n        pass";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ImageClassificationBackbone" class="doc_header"><code>class</code> <code>ImageClassificationBackbone</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L83" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ImageClassificationBackbone</code>() :: <a href="/gale/core.classes.html#GaleModule"><code>GaleModule</code></a></p>
</blockquote>
<p>Abstract class for ImageClassification BackBones</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ImageClassificationBackbone.__init__" class="doc_header"><code>ImageClassificationBackbone.__init__</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L88" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ImageClassificationBackbone.__init__</code>()</p>
</blockquote>
<p>The <code>__init__</code> method of any subclass can specify its own set of arguments.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ImageClassificationBackbone.get_lrs" class="doc_header"><code>ImageClassificationBackbone.get_lrs</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L94" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ImageClassificationBackbone.get_lrs</code>()</p>
</blockquote>
<p>Returns a List containining the Lrs' for
each parameter group. This is required to build schedulers
like <code>torch.optim.lr_scheduler.OneCycleScheduler</code> which needs
the max lrs' for all the Param Groups.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ImageClassificationBackbone.output_shape" class="doc_header"><code>ImageClassificationBackbone.output_shape</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L107" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ImageClassificationBackbone.output_shape</code>()</p>
</blockquote>
<p>Returns the output shape. For most backbones
this means it will contain the channels in the
output layer.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="f5ecb453-e3ed-4f5e-84a3-a2cfd839613a"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f5ecb453-e3ed-4f5e-84a3-a2cfd839613a');

            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "# export\n# @IMAGE_CLASSIFIER_BACKBONES.register()\nclass TimmBackboneBase(ImageClassificationBackbone):\n    \"Create a model from `timm` and converts it into a Image Classification Backbone\"\n\n    @use_kwargs_dict(\n        keep=True,\n        pretrained=True,\n        drop_block_rate=None,\n        drop_path_rate=None,\n        bn_tf=False,\n    )\n    def __init__(\n        self,\n        model_name: str,\n        input_shape: ShapeSpec,\n        act: str = None,\n        lr: float = 1e-03,\n        wd: float = 0,\n        freeze_bn: bool = False,\n        freeze_at: int = False,\n        filter_wd: bool = False,\n        **kwargs,\n    ):\n        super(TimmBackboneBase, self).__init__()\n\n        store_attr(\"lr, wd, filter_wd, input_shape\")\n\n        if act is not None:\n            act = ACTIVATION_REGISTRY.get(act)\n\n        # fmt: off\n        model = create_model(model_name, act_layer=act, global_pool=\"\", num_classes=0, \n                             in_chans=input_shape.channels, **kwargs)\n        # fmt: on\n\n        # save some of the input information from timm models\n        self.num_features = model.num_features\n        self.timm_model_cfg = model.default_cfg\n        self.model = prepare_backbone(model)\n\n        if not freeze_at:\n            self.unfreeze()\n        else:\n            self.freeze_to(freeze_at)\n\n        if freeze_bn:\n            set_bn_eval(self.model)\n\n    def forward(self, xb: torch.Tensor) -> torch.Tensor:\n        return self.model(xb)\n\n    def build_param_dicts(self):\n        if self.filter_wd:\n            ps = filter_weight_decay(self.model, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.model),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps\n\n    def output_shape(self) -> ShapeSpec:\n        return ShapeSpec(self.num_features, None, None)";
                var nbb_formatted_code = "# export\n# @IMAGE_CLASSIFIER_BACKBONES.register()\nclass TimmBackboneBase(ImageClassificationBackbone):\n    \"Create a model from `timm` and converts it into a Image Classification Backbone\"\n\n    @use_kwargs_dict(\n        keep=True,\n        pretrained=True,\n        drop_block_rate=None,\n        drop_path_rate=None,\n        bn_tf=False,\n    )\n    def __init__(\n        self,\n        model_name: str,\n        input_shape: ShapeSpec,\n        act: str = None,\n        lr: float = 1e-03,\n        wd: float = 0,\n        freeze_bn: bool = False,\n        freeze_at: int = False,\n        filter_wd: bool = False,\n        **kwargs,\n    ):\n        super(TimmBackboneBase, self).__init__()\n\n        store_attr(\"lr, wd, filter_wd, input_shape\")\n\n        if act is not None:\n            act = ACTIVATION_REGISTRY.get(act)\n\n        # fmt: off\n        model = create_model(model_name, act_layer=act, global_pool=\"\", num_classes=0, \n                             in_chans=input_shape.channels, **kwargs)\n        # fmt: on\n\n        # save some of the input information from timm models\n        self.num_features = model.num_features\n        self.timm_model_cfg = model.default_cfg\n        self.model = prepare_backbone(model)\n\n        if not freeze_at:\n            self.unfreeze()\n        else:\n            self.freeze_to(freeze_at)\n\n        if freeze_bn:\n            set_bn_eval(self.model)\n\n    def forward(self, xb: torch.Tensor) -> torch.Tensor:\n        return self.model(xb)\n\n    def build_param_dicts(self):\n        if self.filter_wd:\n            ps = filter_weight_decay(self.model, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.model),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps\n\n    def output_shape(self) -> ShapeSpec:\n        return ShapeSpec(self.num_features, None, None)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TimmBackboneBase" class="doc_header"><code>class</code> <code>TimmBackboneBase</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L117" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TimmBackboneBase</code>(<strong><code>model_name</code></strong>:<code>str</code>, <strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>act</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.001</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>freeze_bn</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>freeze_at</code></strong>:<code>int</code>=<em><code>False</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>drop_block_rate</code></strong>=<em><code>None</code></em>, <strong><code>drop_path_rate</code></strong>=<em><code>None</code></em>, <strong><code>bn_tf</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/gale/classification.modelling.backbones.html#ImageClassificationBackbone"><code>ImageClassificationBackbone</code></a></p>
</blockquote>
<p>Create a model from <code>timm</code> and converts it into a Image Classification Backbone</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Arguments to <a href="/gale/classification.modelling.backbones.html#TimmBackboneBase"><code>TimmBackboneBase</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): Shape of the Inputs</li>
<li><code>model_name</code> (str): name of model to instantiate.</li>
<li><code>act</code> (str): name of the activation function to use. If None uses the default activations else the name must be in <a href="/gale/core.utils.structures.html#ACTIVATION_REGISTRY"><code>ACTIVATION_REGISTRY</code></a>.</li>
<li><code>lr</code> (float): learning rate for the modules.</li>
<li><code>wd</code> (float): weight decay for the modules.</li>
<li><code>freeze_bn</code> (bool): freeze the batch normalization layers of the model.</li>
<li><code>freeze_at</code> (int): freeze the layers of the backbone upto <code>freeze_at</code>, false means train all.</li>
<li><code>filter_wd</code> (bool): Filter out bias, bn from weight_decay.</li>
<li><code>pretrained</code> (bool): load pretrained ImageNet-1k weights if true.</li>
<li><code>drop_block_rate</code> (float): Drop block rate</li>
<li><code>drop_path_rate</code> (float): Drop_path_rate</li>
<li><code>bn_tf</code> (bool): Use Tensorflow BatchNorm defaults for models that support it.</li>
<li><code>kwargs</code> (optional): Optional kwargs passed onto <code>timm.create_model()</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">bk</span> <span class="o">=</span> <span class="n">TimmBackboneBase</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;resnet18&quot;</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
<span class="n">o1</span> <span class="o">=</span> <span class="n">bk</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">o1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">bk</span><span class="o">.</span><span class="n">output_shape</span><span class="p">()</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">num_features</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="4db02a73-8366-4294-ae85-f0c8c4c8fc8e"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#4db02a73-8366-4294-ae85-f0c8c4c8fc8e');

            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=3, height=255, width=255)\nbk = TimmBackboneBase(model_name=\"resnet18\", pretrained=True, input_shape=input_shape)\nm = create_model(\"resnet18\")\n\ni = torch.randn(2, 3, 224, 224)\no1 = bk(i)\ntest_eq(o1.shape, torch.Size([2, 512, 7, 7]))\ntest_eq(bk.output_shape().channels, m.num_features)";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=3, height=255, width=255)\nbk = TimmBackboneBase(model_name=\"resnet18\", pretrained=True, input_shape=input_shape)\nm = create_model(\"resnet18\")\n\ni = torch.randn(2, 3, 224, 224)\no1 = bk(i)\ntest_eq(o1.shape, torch.Size([2, 512, 7, 7]))\ntest_eq(bk.output_shape().channels, m.num_features)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiation-using-config">Instantiation using config<a class="anchor-link" href="#Instantiation-using-config"> </a></h3><p>The config for <code>TimmBackboneBaseConfig</code> is going to look like this. We need to convert the dataclass to the Omegaconf config file and then we can use <code>from_config_dict</code> method to instantiate our class.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TimmBackboneBaseConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base config file for `TimmBackboneBase`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">MISSING</span>
    <span class="n">act</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mf">1e-03</span>
    <span class="n">wd</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">freeze_bn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">freeze_at</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">filter_wd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">drop_block_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">drop_path_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bn_tf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># create a config to instantiate the same backbone as above</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">TimmBackboneBaseConfig</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>

<span class="c1"># we need to explicitely pass in the input_shape argument</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">TimmBackboneBase</span><span class="o">.</span><span class="n">from_config_dict</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>

<span class="n">o2</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">o2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">o1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">o2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="9d04553f-f90a-424d-a412-bf219a23563b"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#9d04553f-f90a-424d-a412-bf219a23563b');

            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "@dataclass\nclass TimmBackboneBaseConfig:\n    \"\"\"\n    Base config file for `TimmBackboneBase`\n    \"\"\"\n\n    model_name: str = MISSING\n    act: Optional[str] = None\n    lr: Any = 1e-03\n    wd: Any = 0.0\n    freeze_bn: bool = False\n    freeze_at: Any = False\n    filter_wd: bool = False\n    pretrained: bool = True\n    drop_block_rate: Optional[float] = None\n    drop_path_rate: Optional[float] = None\n    bn_tf: bool = False\n\n\n# create a config to instantiate the same backbone as above\nconf = TimmBackboneBaseConfig(model_name=\"resnet18\", pretrained=True)\nconf = OmegaConf.structured(conf)\n\n# we need to explicitely pass in the input_shape argument\nm = TimmBackboneBase.from_config_dict(conf, input_shape=input_shape)\n\no2 = m(i)\ntest_eq(o2.shape, torch.Size([2, 512, 7, 7]))\n\ntest_eq(o1.data, o2.data)";
                var nbb_formatted_code = "@dataclass\nclass TimmBackboneBaseConfig:\n    \"\"\"\n    Base config file for `TimmBackboneBase`\n    \"\"\"\n\n    model_name: str = MISSING\n    act: Optional[str] = None\n    lr: Any = 1e-03\n    wd: Any = 0.0\n    freeze_bn: bool = False\n    freeze_at: Any = False\n    filter_wd: bool = False\n    pretrained: bool = True\n    drop_block_rate: Optional[float] = None\n    drop_path_rate: Optional[float] = None\n    bn_tf: bool = False\n\n\n# create a config to instantiate the same backbone as above\nconf = TimmBackboneBaseConfig(model_name=\"resnet18\", pretrained=True)\nconf = OmegaConf.structured(conf)\n\n# we need to explicitely pass in the input_shape argument\nm = TimmBackboneBase.from_config_dict(conf, input_shape=input_shape)\n\no2 = m(i)\ntest_eq(o2.shape, torch.Size([2, 512, 7, 7]))\n\ntest_eq(o1.data, o2.data)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="5e1a60fd-8bb4-4919-b3ae-8042842df918"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#5e1a60fd-8bb4-4919-b3ae-8042842df918');

            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "# export\n# fmt: off\n# @IMAGE_CLASSIFIER_BACKBONES.register()\nclass ResNetBackbone(ImageClassificationBackbone):\n    \"\"\"\n    A Backbone for ResNet based models from timm. Note: this class\n    does supports all the models listed [here](https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/models/resnet.py)\n    \"\"\"\n\n    @use_kwargs_dict(\n        keep=True,\n        pretrained=True,  \n        drop_block_rate=None,  \n        drop_path_rate=None,  \n        bn_tf=False,  \n    )\n    \n    def __init__(\n        self,\n        model_name: str,\n        input_shape: ShapeSpec,\n        act: str = None,\n        lr: float = 1e-03,\n        lr_div: float = 10,\n        wd: float = 0,\n        freeze_at: int = 0,\n        **kwargs\n    ):  \n        super(ResNetBackbone, self).__init__()\n        store_attr(\"freeze_at, wd, lr, lr_div, input_shape\", self)\n        \n        if act is not None:\n            act = ACTIVATION_REGISTRY.get(act)\n\n        model = create_model(model_name, act_layer=act, global_pool=\"\", num_classes=0, \n                             in_chans=input_shape.channels, **kwargs)\n        \n        assert isinstance(model, ResNet), \"ResNetBackbone supports only ResNet models\"\n        # save some of the input information from timm models\n        self.num_features = model.num_features\n        self.timm_model_cfg = model.default_cfg\n        \n        # break up the model\n        self.stem = nn.Sequential(model.conv1, model.bn1, model.act1, model.maxpool)\n        self.stages = nn.Sequential(model.layer1, model.layer2, model.layer3, model.layer4)\n        \n        self.prepare_model()\n\n        \n    def forward(self, xb: torch.Tensor) -> torch.Tensor:\n        out = self.stem(xb)\n        return self.stages(out)\n        \n    def build_param_dicts(self) -> Any:\n        p0 = {\"params\": trainable_params(self.stem), \"lr\": self.lr/self.lr_div, \"weight_decay\": self.wd}\n        p1 = {\"params\": trainable_params(self.stages[0:2]), \"lr\": self.lr/self.lr_div, \"weight_decay\": self.wd}\n        p2 = {\"params\": trainable_params(self.stages[2:]), \"lr\": self.lr, \"weight_decay\": self.wd}\n        return [p0, p1, p2]\n        \n    \n    def freeze_block(self, m: nn.Module):\n        \"\"\"\n        Make this block `m` not trainable.\n        This method sets all parameters to `requires_grad=False`,\n        and convert all BatchNorm Layers in eval mode\n        \"\"\"\n        for p in m.parameters():\n            p.requires_grad = False\n        set_bn_eval(m)\n        \n    def prepare_model(self):\n        \"\"\"\n        Freeze the first several stages of the ResNet. Commonly used in fine-tuning.\n        \"\"\"\n        if self.freeze_at >= 1:\n            self.freeze_block(self.stem)\n        for idx, stage in enumerate(self.stages, start=2):\n            if self.freeze_at >= idx:\n                for block in stage.children():\n                    self.freeze_block(block)\n    \n    def output_shape(self) -> ShapeSpec:\n        return ShapeSpec(self.num_features, None, None)\n# fmt: on";
                var nbb_formatted_code = "# export\n# fmt: off\n# @IMAGE_CLASSIFIER_BACKBONES.register()\nclass ResNetBackbone(ImageClassificationBackbone):\n    \"\"\"\n    A Backbone for ResNet based models from timm. Note: this class\n    does supports all the models listed [here](https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/models/resnet.py)\n    \"\"\"\n\n    @use_kwargs_dict(\n        keep=True,\n        pretrained=True,  \n        drop_block_rate=None,  \n        drop_path_rate=None,  \n        bn_tf=False,  \n    )\n    \n    def __init__(\n        self,\n        model_name: str,\n        input_shape: ShapeSpec,\n        act: str = None,\n        lr: float = 1e-03,\n        lr_div: float = 10,\n        wd: float = 0,\n        freeze_at: int = 0,\n        **kwargs\n    ):  \n        super(ResNetBackbone, self).__init__()\n        store_attr(\"freeze_at, wd, lr, lr_div, input_shape\", self)\n        \n        if act is not None:\n            act = ACTIVATION_REGISTRY.get(act)\n\n        model = create_model(model_name, act_layer=act, global_pool=\"\", num_classes=0, \n                             in_chans=input_shape.channels, **kwargs)\n        \n        assert isinstance(model, ResNet), \"ResNetBackbone supports only ResNet models\"\n        # save some of the input information from timm models\n        self.num_features = model.num_features\n        self.timm_model_cfg = model.default_cfg\n        \n        # break up the model\n        self.stem = nn.Sequential(model.conv1, model.bn1, model.act1, model.maxpool)\n        self.stages = nn.Sequential(model.layer1, model.layer2, model.layer3, model.layer4)\n        \n        self.prepare_model()\n\n        \n    def forward(self, xb: torch.Tensor) -> torch.Tensor:\n        out = self.stem(xb)\n        return self.stages(out)\n        \n    def build_param_dicts(self) -> Any:\n        p0 = {\"params\": trainable_params(self.stem), \"lr\": self.lr/self.lr_div, \"weight_decay\": self.wd}\n        p1 = {\"params\": trainable_params(self.stages[0:2]), \"lr\": self.lr/self.lr_div, \"weight_decay\": self.wd}\n        p2 = {\"params\": trainable_params(self.stages[2:]), \"lr\": self.lr, \"weight_decay\": self.wd}\n        return [p0, p1, p2]\n        \n    \n    def freeze_block(self, m: nn.Module):\n        \"\"\"\n        Make this block `m` not trainable.\n        This method sets all parameters to `requires_grad=False`,\n        and convert all BatchNorm Layers in eval mode\n        \"\"\"\n        for p in m.parameters():\n            p.requires_grad = False\n        set_bn_eval(m)\n        \n    def prepare_model(self):\n        \"\"\"\n        Freeze the first several stages of the ResNet. Commonly used in fine-tuning.\n        \"\"\"\n        if self.freeze_at >= 1:\n            self.freeze_block(self.stem)\n        for idx, stage in enumerate(self.stages, start=2):\n            if self.freeze_at >= idx:\n                for block in stage.children():\n                    self.freeze_block(block)\n    \n    def output_shape(self) -> ShapeSpec:\n        return ShapeSpec(self.num_features, None, None)\n# fmt: on";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ResNetBackbone" class="doc_header"><code>class</code> <code>ResNetBackbone</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L181" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ResNetBackbone</code>(<strong><code>model_name</code></strong>:<code>str</code>, <strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>act</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.001</code></em>, <strong><code>lr_div</code></strong>:<code>float</code>=<em><code>10</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>freeze_at</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>drop_block_rate</code></strong>=<em><code>None</code></em>, <strong><code>drop_path_rate</code></strong>=<em><code>None</code></em>, <strong><code>bn_tf</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/gale/classification.modelling.backbones.html#ImageClassificationBackbone"><code>ImageClassificationBackbone</code></a></p>
</blockquote>
<p>A Backbone for ResNet based models from timm. Note: this class
does supports all the models listed <a href="https://github.com/rwightman/pytorch-image-models/blob/e8a64fb88108b592da192e98054095b1ee25e96e/timm/models/resnet.py">here</a></p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ResNetBackbone.prepare_model" class="doc_header"><code>ResNetBackbone.prepare_model</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L248" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ResNetBackbone.prepare_model</code>()</p>
</blockquote>
<p>Freeze the first several stages of the ResNet. Commonly used in fine-tuning.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ResNetBackbone.freeze_block" class="doc_header"><code>ResNetBackbone.freeze_block</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/backbones.py#L238" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ResNetBackbone.freeze_block</code>(<strong><code>m</code></strong>:<code>Module</code>)</p>
</blockquote>
<p>Make this block <code>m</code> not trainable.
This method sets all parameters to <code>requires_grad=False</code>,
and convert all BatchNorm Layers in eval mode</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Arguments to <a href="/gale/classification.modelling.backbones.html#ResNetBackbone"><code>ResNetBackbone</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): Shape of the Inputs</li>
<li><code>model_name</code> (str): name of model to instantiate.</li>
<li><code>act</code> (str): name of the activation function to use. If None uses the default activations else the name must be in <a href="/gale/core.utils.structures.html#ACTIVATION_REGISTRY"><code>ACTIVATION_REGISTRY</code></a>.</li>
<li><code>lr</code> (float): learning rate for the modules.</li>
<li><code>lr_div</code> (int, float): factor for discriminative lrs.   </li>
<li><code>wd</code> (float): weight decay for the modules.</li>
<li><code>freeze_at</code> (int): Freeze the first several stages of the ResNet. Commonly used in fine-tuning. <code>1</code> means freezing the stem. <code>2</code> means freezing the stem and one residual stage, etc.</li>
<li><code>pretrained</code> (bool): load pretrained ImageNet-1k weights if true.</li>
<li><code>drop_block_rate</code> (float): Drop block rate.</li>
<li><code>drop_path_rate</code> (float): Drop path rate.</li>
<li><code>bn_tf</code> (bool): Use Tensorflow BatchNorm defaults for models that support it.</li>
<li><code>kwargs</code> (optional): Optional kwargs passed onto <code>timm.create_model()</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiation-using-config">Instantiation using config<a class="anchor-link" href="#Instantiation-using-config"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ResNetBackboneConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base config file for `ResNetBackbone`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">MISSING</span>
    <span class="n">act</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lr</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mf">1e-03</span>
    <span class="n">lr_div</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">wd</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">freeze_at</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">drop_block_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">drop_path_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bn_tf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># create config from OmegaConf using `ResNetBackboneConfig` dataclass</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">ResNetBackboneConfig</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;resnet34&quot;</span><span class="p">))</span>
<span class="c1"># instantiate cls from config</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">ResNetBackbone</span><span class="o">.</span><span class="n">from_config_dict</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="c6225767-876d-4ad3-a6f5-cbff3cddd76f"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#c6225767-876d-4ad3-a6f5-cbff3cddd76f');

            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "@dataclass\nclass ResNetBackboneConfig:\n    \"\"\"\n    Base config file for `ResNetBackbone`\n    \"\"\"\n\n    model_name: str = MISSING\n    act: Optional[str] = None\n    lr: Any = 1e-03\n    lr_div: Any = 10\n    wd: Any = 0.0\n    freeze_at: int = 0\n    pretrained: bool = True\n    drop_block_rate: Optional[float] = None\n    drop_path_rate: Optional[float] = None\n    bn_tf: bool = False\n\n\n# create config from OmegaConf using `ResNetBackboneConfig` dataclass\nconf = OmegaConf.structured(ResNetBackboneConfig(model_name=\"resnet34\"))\n# instantiate cls from config\nm = ResNetBackbone.from_config_dict(conf, input_shape=input_shape)";
                var nbb_formatted_code = "@dataclass\nclass ResNetBackboneConfig:\n    \"\"\"\n    Base config file for `ResNetBackbone`\n    \"\"\"\n\n    model_name: str = MISSING\n    act: Optional[str] = None\n    lr: Any = 1e-03\n    lr_div: Any = 10\n    wd: Any = 0.0\n    freeze_at: int = 0\n    pretrained: bool = True\n    drop_block_rate: Optional[float] = None\n    drop_path_rate: Optional[float] = None\n    bn_tf: bool = False\n\n\n# create config from OmegaConf using `ResNetBackboneConfig` dataclass\nconf = OmegaConf.structured(ResNetBackboneConfig(model_name=\"resnet34\"))\n# instantiate cls from config\nm = ResNetBackbone.from_config_dict(conf, input_shape=input_shape)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

