---

title: Heads


keywords: fastai
sidebar: home_sidebar

summary: "A head is a regular `torch.nn.Module` that can be attached to a backbone."
description: "A head is a regular `torch.nn.Module` that can be attached to a backbone."
nb_path: "nbs/04a_classification.models.heads.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04a_classification.models.heads.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="9ed24724-e52d-4608-ac7a-52560848c0a9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#9ed24724-e52d-4608-ac7a-52560848c0a9');

            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_HEADS\"]";
                var nbb_formatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_HEADS\"]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ImageClassificationHead" class="doc_header"><code>class</code> <code>ImageClassificationHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/model/heads.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ImageClassificationHead</code>() :: <a href="/gale/core-classes.html#BasicModule"><code>BasicModule</code></a></p>
</blockquote>
<p>Abstract class for ImageClassification Heads</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="3a79974c-8edc-4590-aeed-765348f06ef7"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#3a79974c-8edc-4590-aeed-765348f06ef7');

            setTimeout(function() {
                var nbb_cell_id = 24;
                var nbb_unformatted_code = "# export\nclass ImageClassificationHead(BasicModule):\n    \"\"\"\n    Abstract class for ImageClassification Heads\n    \"\"\"\n\n    _hypers = namedtuple(\"hypers\", field_names=[\"lr\", \"wd\"])\n\n    @property\n    def hypers(self) -> Tuple:\n        \"\"\"\n        Returns list of parameters like `lr` and `wd`\n        for each param group\n        \"\"\"\n        lrs = []\n        wds = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n            wds.append(p[\"weight_decay\"])\n        return self._hypers(lrs, wds)";
                var nbb_formatted_code = "# export\nclass ImageClassificationHead(BasicModule):\n    \"\"\"\n    Abstract class for ImageClassification Heads\n    \"\"\"\n\n    _hypers = namedtuple(\"hypers\", field_names=[\"lr\", \"wd\"])\n\n    @property\n    def hypers(self) -> Tuple:\n        \"\"\"\n        Returns list of parameters like `lr` and `wd`\n        for each param group\n        \"\"\"\n        lrs = []\n        wds = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n            wds.append(p[\"weight_decay\"])\n        return self._hypers(lrs, wds)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ImageClassificationHead.hypers" class="doc_header"><code>ImageClassificationHead.hypers</code><a href="" class="source_link" style="float:right">[source]</a></h4><p>Returns list of parameters like <code>lr</code> and <code>wd</code>
for each param group</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FullyConnectedHead">FullyConnectedHead<a class="anchor-link" href="#FullyConnectedHead"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FullyConnectedHead" class="doc_header"><code>class</code> <code>FullyConnectedHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/model/heads.py#L54" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FullyConnectedHead</code>(<strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>pool_type</code></strong>:<code>str</code>=<em><code>'avg'</code></em>, <strong><code>drop_rate</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>use_conv</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.002</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <a href="/gale/classification.models.heads.html#ImageClassificationHead"><code>ImageClassificationHead</code></a></p>
</blockquote>
<p>Classifier head w/ configurable global pooling and dropout.
From - <a href="https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py">https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="3c63bbe5-bf9d-4b30-a044-bd8089d72ab2"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#3c63bbe5-bf9d-4b30-a044-bd8089d72ab2');

            setTimeout(function() {
                var nbb_cell_id = 26;
                var nbb_unformatted_code = "# export\nclass FullyConnectedHead(ImageClassificationHead):\n    \"\"\"\n    Classifier head w/ configurable global pooling and dropout.\n    From - https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        pool_type: str = \"avg\",\n        drop_rate: float = 0.0,\n        use_conv: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FullyConnectedHead, self).__init__()\n        self.drop_rate = drop_rate\n        in_planes = input_shape.channels\n        # fmt: off\n        self.global_pool, num_pooled_features = _create_pool(in_planes, num_classes, pool_type, use_conv=use_conv)\n        # fmt: on\n        self.fc = _create_fc(num_pooled_features, num_classes, use_conv=use_conv)\n        self.flatten_after_fc = use_conv and pool_type\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, x):\n        x = self.global_pool(x)\n        if self.drop_rate:\n            x = F.dropout(x, p=float(self.drop_rate), training=self.training)\n        x = self.fc(x)\n        return x\n\n    def build_param_dicts(self) -> Any:\n        # fmt: off\n        if self.filter_wd:\n            ps = filter_weight_decay(self, lr=self.lr, weight_decay=self.wd)\n        else:\n            ps = [{\"params\": trainable_params(self),\"lr\": self.lr,\"weight_decay\": self.wd}]\n        return ps";
                var nbb_formatted_code = "# export\nclass FullyConnectedHead(ImageClassificationHead):\n    \"\"\"\n    Classifier head w/ configurable global pooling and dropout.\n    From - https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        pool_type: str = \"avg\",\n        drop_rate: float = 0.0,\n        use_conv: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FullyConnectedHead, self).__init__()\n        self.drop_rate = drop_rate\n        in_planes = input_shape.channels\n        # fmt: off\n        self.global_pool, num_pooled_features = _create_pool(in_planes, num_classes, pool_type, use_conv=use_conv)\n        # fmt: on\n        self.fc = _create_fc(num_pooled_features, num_classes, use_conv=use_conv)\n        self.flatten_after_fc = use_conv and pool_type\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, x):\n        x = self.global_pool(x)\n        if self.drop_rate:\n            x = F.dropout(x, p=float(self.drop_rate), training=self.training)\n        x = self.fc(x)\n        return x\n\n    def build_param_dicts(self) -> Any:\n        # fmt: off\n        if self.filter_wd:\n            ps = filter_weight_decay(self, lr=self.lr, weight_decay=self.wd)\n        else:\n            ps = [{\"params\": trainable_params(self),\"lr\": self.lr,\"weight_decay\": self.wd}]\n        return ps";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Arguments to <a href="/gale/classification.models.heads.html#FullyConnectedHead"><code>FullyConnectedHead</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): input shape</li>
<li><code>num_classes</code> (int): Number of classes for the head.</li>
<li><code>pool_type</code> (str): The pooling layer to use. Check <a href="https://github.com/rwightman/pytorch-image-models/blob/9a1bd358c7e998799eed88b29842e3c9e5483e34/timm/models/layers/adaptive_avgmax_pool.py#L79">here</a>.</li>
<li><code>drop_rate</code> (float): If &gt;0.0 then applies dropout between the pool_layer and the fc layer.</li>
<li><code>use_conv</code> (bool): Use a convolutional layer as the final fc layer.</li>
<li><code>lr</code> (float): Learning rate for the modules.</li>
<li><code>wd</code> (float): Weight decay for the modules.</li>
<li><code>filter_wd</code> (bool): Filter out <code>bias</code>, <code>bn</code> from <code>weight_decay</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FullyConnectedHead</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FullyConnectedHead(
  (global_pool): SelectAdaptivePool2d (pool_type=avg, flatten=True)
  (fc): Linear(in_features=512, out_features=10, bias=True)
)</pre>
</div>

</div>

<div class="output_area">




<div id="d2df515d-3e83-4643-bde3-103d9f932187"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d2df515d-3e83-4643-bde3-103d9f932187');

            setTimeout(function() {
                var nbb_cell_id = 27;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FullyConnectedHead(input_shape, 10)\ntst";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FullyConnectedHead(input_shape, 10)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dataclass">Dataclass<a class="anchor-link" href="#Dataclass"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FCHeadDataClass" class="doc_header"><code>class</code> <code>FCHeadDataClass</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/model/heads.py#L99" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FCHeadDataClass</code>(<strong><code>num_classes</code></strong>:<code>int</code>=<em><code>'???'</code></em>, <strong><code>pool_type</code></strong>:<code>str</code>=<em><code>'avg'</code></em>, <strong><code>drop_rate</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>use_conv</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.001</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0.0</code></em>)</p>
</blockquote>
<p>Base config for <a href="/gale/classification.models.heads.html#FullyConnectedHead"><code>FullyConnectedHead</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="d25b3133-a34c-45b2-9845-7aa2d3ad2fd4"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#d25b3133-a34c-45b2-9845-7aa2d3ad2fd4');

            setTimeout(function() {
                var nbb_cell_id = 44;
                var nbb_unformatted_code = "# export\n@dataclass\nclass FCHeadDataClass:\n    \"\"\"\n    Base config for `FullyConnectedHead`\n    \"\"\"\n\n    num_classes: int = MISSING\n    pool_type: str = \"avg\"\n    drop_rate: float = 0.0\n    use_conv: bool = False\n    lr: float = 1e-03\n    wd: float = 0.0\n    use_conv: bool = False";
                var nbb_formatted_code = "# export\n@dataclass\nclass FCHeadDataClass:\n    \"\"\"\n    Base config for `FullyConnectedHead`\n    \"\"\"\n\n    num_classes: int = MISSING\n    pool_type: str = \"avg\"\n    drop_rate: float = 0.0\n    use_conv: bool = False\n    lr: float = 1e-03\n    wd: float = 0.0\n    use_conv: bool = False";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">FCHeadDataClass</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FullyConnectedHead</span><span class="o">.</span><span class="n">from_config_dict</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FullyConnectedHead(
  (global_pool): SelectAdaptivePool2d (pool_type=avg, flatten=True)
  (fc): Linear(in_features=512, out_features=10, bias=True)
)</pre>
</div>

</div>

<div class="output_area">




<div id="ab35289f-5ece-449b-b438-b730c6fbbd46"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#ab35289f-5ece-449b-b438-b730c6fbbd46');

            setTimeout(function() {
                var nbb_cell_id = 45;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=512)\nc = OmegaConf.structured(FCHeadDataClass(num_classes=10))\ntst = FullyConnectedHead.from_config_dict(c, input_shape=input_shape)\ntst";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=512)\nc = OmegaConf.structured(FCHeadDataClass(num_classes=10))\ntst = FullyConnectedHead.from_config_dict(c, input_shape=input_shape)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FastaiHead">FastaiHead<a class="anchor-link" href="#FastaiHead"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FastaiHead" class="doc_header"><code>class</code> <code>FastaiHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/model/heads.py#L113" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FastaiHead</code>(<strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>act</code></strong>:<code>str</code>=<em><code>'ReLU'</code></em>, <strong><code>lin_ftrs</code></strong>:<code>Optional</code>[<code>List</code>]=<em><code>None</code></em>, <strong><code>ps</code></strong>:<code>Union</code>[<code>List</code>, <code>int</code>]=<em><code>0.5</code></em>, <strong><code>concat_pool</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>first_bn</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>bn_final</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.002</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <a href="/gale/classification.models.heads.html#ImageClassificationHead"><code>ImageClassificationHead</code></a></p>
</blockquote>
<p>Model head that takes <code>in_planes</code> features, runs through <code>lin_ftrs</code>, and out <code>num_classes</code> classes.</p>
<p>From -
<a href="https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76">https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="b62bf91b-551e-4f8b-b4ef-c0222978efcd"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#b62bf91b-551e-4f8b-b4ef-c0222978efcd');

            setTimeout(function() {
                var nbb_cell_id = 40;
                var nbb_unformatted_code = "# export\nclass FastaiHead(ImageClassificationHead):\n    \"\"\"\n    Model head that takes `in_planes` features, runs through `lin_ftrs`, and out `num_classes` classes.\n\n    From -\n    https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        act: str = \"ReLU\",\n        lin_ftrs: Optional[List] = None,\n        ps: Union[List, int] = 0.5,\n        concat_pool: bool = True,\n        first_bn: bool = True,\n        bn_final: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FastaiHead, self).__init__()\n        in_planes = input_shape.channels\n        pool = \"catavgmax\" if concat_pool else \"avg\"\n        pool, nf = _create_pool(in_planes, num_classes, pool, use_conv=False)\n\n        # fmt: off\n        lin_ftrs = [nf, 512, num_classes] if lin_ftrs is None else [nf] + lin_ftrs + [num_classes]\n        # fmt: on\n\n        bns = [first_bn] + [True] * len(lin_ftrs[1:])\n\n        ps = L(ps)\n\n        if len(ps) == 1:\n            ps = [ps[0] / 2] * (len(lin_ftrs) - 2) + ps\n\n        act = ifnone(act, \"ReLU\")\n        # fmt: off\n        actns = [ACTIVATION_REGISTRY.get(act)(inplace=True)] * (len(lin_ftrs) - 2) + [None]\n        if bn_final:\n            actns[-1] = ACTIVATION_REGISTRY.get(act)(inplace=True)\n        # fmt: on\n\n        self.layers = [pool]\n\n        for ni, no, bn, p, actn in zip(lin_ftrs[:-1], lin_ftrs[1:], bns, ps, actns):\n            self.layers += nn.Sequential(\n                nn.BatchNorm1d(ni), nn.Dropout(p), nn.Linear(ni, no, bias=not bns), actn\n            )\n\n        if bn_final:\n            self.layers.append(nn.BatchNorm1d(lin_ftrs[-1], momentum=0.01))\n        self.layers = nn.Sequential(*[l for l in self.layers if l is not None])\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, xb: torch.Tensor) -> Any:\n        return self.layers(xb)\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self.layers, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.layers),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_formatted_code = "# export\nclass FastaiHead(ImageClassificationHead):\n    \"\"\"\n    Model head that takes `in_planes` features, runs through `lin_ftrs`, and out `num_classes` classes.\n\n    From -\n    https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        act: str = \"ReLU\",\n        lin_ftrs: Optional[List] = None,\n        ps: Union[List, int] = 0.5,\n        concat_pool: bool = True,\n        first_bn: bool = True,\n        bn_final: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FastaiHead, self).__init__()\n        in_planes = input_shape.channels\n        pool = \"catavgmax\" if concat_pool else \"avg\"\n        pool, nf = _create_pool(in_planes, num_classes, pool, use_conv=False)\n\n        # fmt: off\n        lin_ftrs = [nf, 512, num_classes] if lin_ftrs is None else [nf] + lin_ftrs + [num_classes]\n        # fmt: on\n\n        bns = [first_bn] + [True] * len(lin_ftrs[1:])\n\n        ps = L(ps)\n\n        if len(ps) == 1:\n            ps = [ps[0] / 2] * (len(lin_ftrs) - 2) + ps\n\n        act = ifnone(act, \"ReLU\")\n        # fmt: off\n        actns = [ACTIVATION_REGISTRY.get(act)(inplace=True)] * (len(lin_ftrs) - 2) + [None]\n        if bn_final:\n            actns[-1] = ACTIVATION_REGISTRY.get(act)(inplace=True)\n        # fmt: on\n\n        self.layers = [pool]\n\n        for ni, no, bn, p, actn in zip(lin_ftrs[:-1], lin_ftrs[1:], bns, ps, actns):\n            self.layers += nn.Sequential(\n                nn.BatchNorm1d(ni), nn.Dropout(p), nn.Linear(ni, no, bias=not bns), actn\n            )\n\n        if bn_final:\n            self.layers.append(nn.BatchNorm1d(lin_ftrs[-1], momentum=0.01))\n        self.layers = nn.Sequential(*[l for l in self.layers if l is not None])\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, xb: torch.Tensor) -> Any:\n        return self.layers(xb)\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self.layers, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.layers),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The head begins with <code>AdaptiveConcatPool2d</code> if <code>concat_pool=True</code> otherwise, it uses traditional average pooling. Then it uses a Flatten layer before going on blocks of <code>BatchNorm</code>, <code>Dropout</code> and <code>Linear</code> layers.</p>
<p>Those blocks start at <code>in_planes</code>, then every element of <code>lin_ftrs</code> (defaults to [512]) and end at <code>num_classes</code>. <code>ps</code> is a list of probabilities used for the dropouts (if you only pass 1, it will use half the value then that value as many times as necessary).</p>
<p>Arguments to <a href="/gale/classification.models.heads.html#FastaiHead"><code>FastaiHead</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): input shape</li>
<li><code>num_classes</code> (int): Number of classes for the head.</li>
<li><code>act</code> (str): name of the activation function to use. If None uses the default activations else the name must be in ACTIVATION_REGISTRY. Activation layers are used after every block (<code>BatchNorm</code>, <code>Dropout</code> and <code>Linear</code> layers) if it is not the last block.</li>
<li><code>lin_ftrs</code> (List): Features of the Linear layers. (defaults to [512])</li>
<li><code>ps</code> (List): list of probabilities used for the dropouts.</li>
<li><code>concat_pool</code> (bool): Wether to use <code>AdaptiveConcatPool2d</code> or <code>AdaptiveAveragePool2d</code>.</li>
<li><code>first_bn</code> (bool): BatchNorm Layer after pool.</li>
<li><code>bn_final</code> (bool): Final Layer is BatchNorm.</li>
<li><code>lr</code> (float): Learning rate for the modules.</li>
<li><code>wd</code> (float): Weight decay for the modules.</li>
<li><code>filter_wd</code> (bool): Filter out <code>bias</code>, <code>bn</code> from <code>weight_decay</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FastaiHead</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FastaiHead(
  (layers): Sequential(
    (0): SelectAdaptivePool2d (pool_type=catavgmax, flatten=True)
    (1): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Dropout(p=0.25, inplace=False)
    (3): Linear(in_features=1024, out_features=512, bias=False)
    (4): ReLU(inplace=True)
    (5): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (6): Dropout(p=0.5, inplace=False)
    (7): Linear(in_features=512, out_features=10, bias=False)
  )
)</pre>
</div>

</div>

<div class="output_area">




<div id="bd59ea68-b449-401b-9a22-e2d2f2bbc21e"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#bd59ea68-b449-401b-9a22-e2d2f2bbc21e');

            setTimeout(function() {
                var nbb_cell_id = 41;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FastaiHead(input_shape=input_shape, num_classes=10)\ntst";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FastaiHead(input_shape=input_shape, num_classes=10)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dataclass">Dataclass<a class="anchor-link" href="#Dataclass"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FastaiHeadDataClass" class="doc_header"><code>class</code> <code>FastaiHeadDataClass</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/model/heads.py#L185" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FastaiHeadDataClass</code>(<strong><code>num_classes</code></strong>:<code>int</code>=<em><code>'???'</code></em>, <strong><code>act</code></strong>:<code>str</code>=<em><code>'ReLU'</code></em>, <strong><code>lin_ftrs</code></strong>:<code>Optional</code>[<code>List</code>]=<em><code>None</code></em>, <strong><code>ps</code></strong>:<code>Any</code>=<em><code>0.5</code></em>, <strong><code>concat_pool</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>first_bn</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>bn_final</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.002</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>FastaiHeadDataClass(num_classes:int='???', act:str='ReLU', lin_ftrs:Union[List, NoneType]=None, ps:Any=0.5, concat_pool:bool=True, first_bn:bool=True, bn_final:bool=False, lr:float=0.002, wd:float=0, filter_wd:bool=False)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="54094d4c-d0ab-4a4d-b812-d0369608fdc3"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#54094d4c-d0ab-4a4d-b812-d0369608fdc3');

            setTimeout(function() {
                var nbb_cell_id = 46;
                var nbb_unformatted_code = "# export\n@dataclass\nclass FastaiHeadDataClass:\n    num_classes: int = MISSING\n    act: str = \"ReLU\"\n    lin_ftrs: Optional[List] = None\n    ps: Any = 0.5\n    concat_pool: bool = True\n    first_bn: bool = True\n    bn_final: bool = False\n    lr: float = 0.002\n    wd: float = 0\n    filter_wd: bool = False";
                var nbb_formatted_code = "# export\n@dataclass\nclass FastaiHeadDataClass:\n    num_classes: int = MISSING\n    act: str = \"ReLU\"\n    lin_ftrs: Optional[List] = None\n    ps: Any = 0.5\n    concat_pool: bool = True\n    first_bn: bool = True\n    bn_final: bool = False\n    lr: float = 0.002\n    wd: float = 0\n    filter_wd: bool = False";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">FastaiHeadDataClass</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FastaiHead</span><span class="o">.</span><span class="n">from_config_dict</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FastaiHead(
  (layers): Sequential(
    (0): SelectAdaptivePool2d (pool_type=catavgmax, flatten=True)
    (1): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Dropout(p=0.25, inplace=False)
    (3): Linear(in_features=1024, out_features=512, bias=False)
    (4): ReLU(inplace=True)
    (5): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (6): Dropout(p=0.5, inplace=False)
    (7): Linear(in_features=512, out_features=10, bias=False)
  )
)</pre>
</div>

</div>

<div class="output_area">




<div id="692bb3a3-f2c8-4c20-a45c-77c667afe4c9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#692bb3a3-f2c8-4c20-a45c-77c667afe4c9');

            setTimeout(function() {
                var nbb_cell_id = 47;
                var nbb_unformatted_code = "conf = OmegaConf.structured(FastaiHeadDataClass(num_classes=10))\n\ntst = FastaiHead.from_config_dict(conf, input_shape=input_shape)\ntst";
                var nbb_formatted_code = "conf = OmegaConf.structured(FastaiHeadDataClass(num_classes=10))\n\ntst = FastaiHead.from_config_dict(conf, input_shape=input_shape)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

