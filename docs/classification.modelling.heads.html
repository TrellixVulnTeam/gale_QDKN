---

title: Heads


keywords: fastai
sidebar: home_sidebar

summary: "A head is a regular `torch.nn.Module` that can be attached to a backbone."
description: "A head is a regular `torch.nn.Module` that can be attached to a backbone."
nb_path: "nbs/04a_classification.modelling.heads.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04a_classification.modelling.heads.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="90e72468-abac-4a03-b817-288272644b74"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#90e72468-abac-4a03-b817-288272644b74');

            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_HEADS\"]";
                var nbb_formatted_code = "# export\n_all_ = [\"IMAGE_CLASSIFIER_HEADS\"]";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ImageClassificationHead" class="doc_header"><code>class</code> <code>ImageClassificationHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/heads.py#L28" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ImageClassificationHead</code>() :: <a href="/gale/core.classes.html#GaleModule"><code>GaleModule</code></a></p>
</blockquote>
<p>Abstract class for ImageClassification Heads</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="b65d3ed7-f7d6-4bdf-b5af-68a79073e8b9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#b65d3ed7-f7d6-4bdf-b5af-68a79073e8b9');

            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "# export\nclass ImageClassificationHead(GaleModule):\n    \"\"\"\n    Abstract class for ImageClassification Heads\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"\n        The `__init__` method of any subclass can specify its own set of arguments.\n        \"\"\"\n        super().__init__()\n\n    def get_lrs(self) -> List:\n        \"\"\"\n        Returns a List containining the Lrs' for\n        each parameter group. This is required to build schedulers\n        like `torch.optim.lr_scheduler.OneCycleScheduler` which needs\n        the max lrs' for all the Param Groups.\n        \"\"\"\n        lrs = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n        return lrs";
                var nbb_formatted_code = "# export\nclass ImageClassificationHead(GaleModule):\n    \"\"\"\n    Abstract class for ImageClassification Heads\n    \"\"\"\n\n    def __init__(self):\n        \"\"\"\n        The `__init__` method of any subclass can specify its own set of arguments.\n        \"\"\"\n        super().__init__()\n\n    def get_lrs(self) -> List:\n        \"\"\"\n        Returns a List containining the Lrs' for\n        each parameter group. This is required to build schedulers\n        like `torch.optim.lr_scheduler.OneCycleScheduler` which needs\n        the max lrs' for all the Param Groups.\n        \"\"\"\n        lrs = []\n\n        for p in self.build_param_dicts():\n            lrs.append(p[\"lr\"])\n        return lrs";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ImageClassificationHead.get_lrs" class="doc_header"><code>ImageClassificationHead.get_lrs</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/heads.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ImageClassificationHead.get_lrs</code>()</p>
</blockquote>
<p>Returns a List containining the Lrs' for
each parameter group. This is required to build schedulers
like <code>torch.optim.lr_scheduler.OneCycleScheduler</code> which needs
the max lrs' for all the Param Groups.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FullyConnectedHead">FullyConnectedHead<a class="anchor-link" href="#FullyConnectedHead"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FullyConnectedHead" class="doc_header"><code>class</code> <code>FullyConnectedHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/heads.py#L53" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FullyConnectedHead</code>(<strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>pool_type</code></strong>:<code>str</code>=<em><code>'avg'</code></em>, <strong><code>drop_rate</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>use_conv</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.002</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <a href="/gale/classification.modelling.heads.html#ImageClassificationHead"><code>ImageClassificationHead</code></a></p>
</blockquote>
<p>Classifier head w/ configurable global pooling and dropout.
From - <a href="https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py">https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="295335ed-0a8e-4325-ab17-e34ecaa8e1b9"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#295335ed-0a8e-4325-ab17-e34ecaa8e1b9');

            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "# export\nclass FullyConnectedHead(ImageClassificationHead):\n    \"\"\"\n    Classifier head w/ configurable global pooling and dropout.\n    From - https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        pool_type: str = \"avg\",\n        drop_rate: float = 0.0,\n        use_conv: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FullyConnectedHead, self).__init__()\n        self.drop_rate = drop_rate\n        in_planes = input_shape.channels\n        # fmt: off\n        self.global_pool, num_pooled_features = _create_pool(in_planes, num_classes, pool_type, use_conv=use_conv)\n        # fmt: on\n        self.fc = _create_fc(num_pooled_features, num_classes, use_conv=use_conv)\n        self.flatten_after_fc = use_conv and pool_type\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, x):\n        x = self.global_pool(x)\n        if self.drop_rate:\n            x = F.dropout(x, p=float(self.drop_rate), training=self.training)\n        x = self.fc(x)\n        return x\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_formatted_code = "# export\nclass FullyConnectedHead(ImageClassificationHead):\n    \"\"\"\n    Classifier head w/ configurable global pooling and dropout.\n    From - https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/classifier.py\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        pool_type: str = \"avg\",\n        drop_rate: float = 0.0,\n        use_conv: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FullyConnectedHead, self).__init__()\n        self.drop_rate = drop_rate\n        in_planes = input_shape.channels\n        # fmt: off\n        self.global_pool, num_pooled_features = _create_pool(in_planes, num_classes, pool_type, use_conv=use_conv)\n        # fmt: on\n        self.fc = _create_fc(num_pooled_features, num_classes, use_conv=use_conv)\n        self.flatten_after_fc = use_conv and pool_type\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, x):\n        x = self.global_pool(x)\n        if self.drop_rate:\n            x = F.dropout(x, p=float(self.drop_rate), training=self.training)\n        x = self.fc(x)\n        return x\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Arguments to <a href="/gale/classification.modelling.heads.html#FullyConnectedHead"><code>FullyConnectedHead</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): input shape</li>
<li><code>num_classes</code> (int): Number of classes for the head.</li>
<li><code>pool_type</code> (str): The pooling layer to use. Check <a href="https://github.com/rwightman/pytorch-image-models/blob/9a1bd358c7e998799eed88b29842e3c9e5483e34/timm/models/layers/adaptive_avgmax_pool.py#L79">here</a>.</li>
<li><code>drop_rate</code> (float): If &gt;0.0 then applies dropout between the pool_layer and the fc layer.</li>
<li><code>use_conv</code> (bool): Use a convolutional layer as the final fc layer.</li>
<li><code>lr</code> (float): Learning rate for the modules.</li>
<li><code>wd</code> (float): Weight decay for the modules.</li>
<li><code>filter_wd</code> (bool): Filter out <code>bias</code>, <code>bn</code> from <code>weight_decay</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FullyConnectedHead</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FullyConnectedHead(
  (global_pool): SelectAdaptivePool2d (pool_type=avg, flatten=True)
  (fc): Linear(in_features=512, out_features=10, bias=True)
)</pre>
</div>

</div>

<div class="output_area">




<div id="99f4388b-77c6-4ccf-b9ee-8e3424848959"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#99f4388b-77c6-4ccf-b9ee-8e3424848959');

            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FullyConnectedHead(input_shape, 10)\ntst";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FullyConnectedHead(input_shape, 10)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FastaiHead">FastaiHead<a class="anchor-link" href="#FastaiHead"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FastaiHead" class="doc_header"><code>class</code> <code>FastaiHead</code><a href="https://github.com/benihime91/gale/tree/master/gale/classification/modelling/heads.py#L98" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FastaiHead</code>(<strong><code>input_shape</code></strong>:<code>ShapeSpec</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>act</code></strong>:<code>str</code>=<em><code>'ReLU'</code></em>, <strong><code>lin_ftrs</code></strong>:<code>Optional</code>[<code>List</code>]=<em><code>None</code></em>, <strong><code>ps</code></strong>:<code>Union</code>[<code>List</code>, <code>int</code>]=<em><code>0.5</code></em>, <strong><code>concat_pool</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>first_bn</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>bn_final</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>lr</code></strong>:<code>float</code>=<em><code>0.002</code></em>, <strong><code>wd</code></strong>:<code>float</code>=<em><code>0</code></em>, <strong><code>filter_wd</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <a href="/gale/classification.modelling.heads.html#ImageClassificationHead"><code>ImageClassificationHead</code></a></p>
</blockquote>
<p>Model head that takes <code>in_planes</code> features, runs through <code>lin_ftrs</code>, and out <code>num_classes</code> classes.</p>
<p>From -
<a href="https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76">https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="869cb045-7c59-4184-a630-99b8bc84a628"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#869cb045-7c59-4184-a630-99b8bc84a628');

            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "# export\nclass FastaiHead(ImageClassificationHead):\n    \"\"\"\n    Model head that takes `in_planes` features, runs through `lin_ftrs`, and out `num_classes` classes.\n\n    From -\n    https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        act: str = \"ReLU\",\n        lin_ftrs: Optional[List] = None,\n        ps: Union[List, int] = 0.5,\n        concat_pool: bool = True,\n        first_bn: bool = True,\n        bn_final: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FastaiHead, self).__init__()\n        in_planes = input_shape.channels\n        pool = \"catavgmax\" if concat_pool else \"avg\"\n        pool, nf = _create_pool(in_planes, num_classes, pool, use_conv=False)\n\n        # fmt: off\n        lin_ftrs = [nf, 512, num_classes] if lin_ftrs is None else [nf] + lin_ftrs + [num_classes]\n        # fmt: on\n\n        bns = [first_bn] + [True] * len(lin_ftrs[1:])\n\n        ps = L(ps)\n\n        if len(ps) == 1:\n            ps = [ps[0] / 2] * (len(lin_ftrs) - 2) + ps\n\n        act = ifnone(act, \"ReLU\")\n        # fmt: off\n        actns = [ACTIVATION_REGISTRY.get(act)(inplace=True)] * (len(lin_ftrs) - 2) + [None]\n        if bn_final:\n            actns[-1] = ACTIVATION_REGISTRY.get(act)(inplace=True)\n        # fmt: on\n\n        self.layers = [pool]\n\n        for ni, no, bn, p, actn in zip(lin_ftrs[:-1], lin_ftrs[1:], bns, ps, actns):\n            self.layers += nn.Sequential(\n                nn.BatchNorm1d(ni), nn.Dropout(p), nn.Linear(ni, no, bias=not bns), actn\n            )\n\n        if bn_final:\n            self.layers.append(nn.BatchNorm1d(lin_ftrs[-1], momentum=0.01))\n        self.layers = nn.Sequential(*[l for l in self.layers if l is not None])\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, xb: torch.Tensor) -> Any:\n        return self.layers(xb)\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self.layers, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.layers),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_formatted_code = "# export\nclass FastaiHead(ImageClassificationHead):\n    \"\"\"\n    Model head that takes `in_planes` features, runs through `lin_ftrs`, and out `num_classes` classes.\n\n    From -\n    https://github.com/fastai/fastai/blob/8b1da8765fc07f1232c20fa8dc5e909d2835640c/fastai/vision/learner.py#L76\n    \"\"\"\n\n    def __init__(\n        self,\n        input_shape: ShapeSpec,\n        num_classes: int,\n        act: str = \"ReLU\",\n        lin_ftrs: Optional[List] = None,\n        ps: Union[List, int] = 0.5,\n        concat_pool: bool = True,\n        first_bn: bool = True,\n        bn_final: bool = False,\n        lr: float = 2e-03,\n        wd: float = 0,\n        filter_wd: bool = False,\n    ):\n        super(FastaiHead, self).__init__()\n        in_planes = input_shape.channels\n        pool = \"catavgmax\" if concat_pool else \"avg\"\n        pool, nf = _create_pool(in_planes, num_classes, pool, use_conv=False)\n\n        # fmt: off\n        lin_ftrs = [nf, 512, num_classes] if lin_ftrs is None else [nf] + lin_ftrs + [num_classes]\n        # fmt: on\n\n        bns = [first_bn] + [True] * len(lin_ftrs[1:])\n\n        ps = L(ps)\n\n        if len(ps) == 1:\n            ps = [ps[0] / 2] * (len(lin_ftrs) - 2) + ps\n\n        act = ifnone(act, \"ReLU\")\n        # fmt: off\n        actns = [ACTIVATION_REGISTRY.get(act)(inplace=True)] * (len(lin_ftrs) - 2) + [None]\n        if bn_final:\n            actns[-1] = ACTIVATION_REGISTRY.get(act)(inplace=True)\n        # fmt: on\n\n        self.layers = [pool]\n\n        for ni, no, bn, p, actn in zip(lin_ftrs[:-1], lin_ftrs[1:], bns, ps, actns):\n            self.layers += nn.Sequential(\n                nn.BatchNorm1d(ni), nn.Dropout(p), nn.Linear(ni, no, bias=not bns), actn\n            )\n\n        if bn_final:\n            self.layers.append(nn.BatchNorm1d(lin_ftrs[-1], momentum=0.01))\n        self.layers = nn.Sequential(*[l for l in self.layers if l is not None])\n\n        store_attr(\"lr, wd, filter_wd\")\n\n    def forward(self, xb: torch.Tensor) -> Any:\n        return self.layers(xb)\n\n    def build_param_dicts(self) -> Any:\n        if self.filter_wd:\n            ps = filter_weight_decay(self.layers, lr=self.lr, weight_decay=self.wd)\n        else:\n            # fmt: off\n            ps = [{\"params\": trainable_params(self.layers),\"lr\": self.lr,\"weight_decay\": self.wd}]\n            # fmt: on\n        return ps";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The head begins with <code>AdaptiveConcatPool2d</code> if <code>concat_pool=True</code> otherwise, it uses traditional average pooling. Then it uses a Flatten layer before going on blocks of <code>BatchNorm</code>, <code>Dropout</code> and <code>Linear</code> layers.</p>
<p>Those blocks start at <code>in_planes</code>, then every element of <code>lin_ftrs</code> (defaults to [512]) and end at <code>num_classes</code>. <code>ps</code> is a list of probabilities used for the dropouts (if you only pass 1, it will use half the value then that value as many times as necessary).</p>
<p>Arguments to <a href="/gale/classification.modelling.heads.html#FastaiHead"><code>FastaiHead</code></a>:</p>
<ul>
<li><code>input_shape</code> (ShapeSpec): input shape</li>
<li><code>num_classes</code> (int): Number of classes for the head.</li>
<li><code>act</code> (str): name of the activation function to use. If None uses the default activations else the name must be in ACTIVATION_REGISTRY. Activation layers are used after every block (<code>BatchNorm</code>, <code>Dropout</code> and <code>Linear</code> layers) if it is not the last block.</li>
<li><code>lin_ftrs</code> (List): Features of the Linear layers. (defaults to [512])</li>
<li><code>ps</code> (List): list of probabilities used for the dropouts.</li>
<li><code>concat_pool</code> (bool): Wether to use <code>AdaptiveConcatPool2d</code> or <code>AdaptiveAveragePool2d</code>.</li>
<li><code>first_bn</code> (bool): BatchNorm Layer after pool.</li>
<li><code>bn_final</code> (bool): Final Layer is BatchNorm.</li>
<li><code>lr</code> (float): Learning rate for the modules.</li>
<li><code>wd</code> (float): Weight decay for the modules.</li>
<li><code>filter_wd</code> (bool): Filter out <code>bias</code>, <code>bn</code> from <code>weight_decay</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">ShapeSpec</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">FastaiHead</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FastaiHead(
  (layers): Sequential(
    (0): SelectAdaptivePool2d (pool_type=catavgmax, flatten=True)
    (1): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Dropout(p=0.25, inplace=False)
    (3): Linear(in_features=1024, out_features=512, bias=False)
    (4): ReLU(inplace=True)
    (5): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (6): Dropout(p=0.5, inplace=False)
    (7): Linear(in_features=512, out_features=10, bias=False)
  )
)</pre>
</div>

</div>

<div class="output_area">




<div id="8a056d1e-cdde-46be-b16e-2539d29105e6"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#8a056d1e-cdde-46be-b16e-2539d29105e6');

            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FastaiHead(input_shape=input_shape, num_classes=10)\ntst";
                var nbb_formatted_code = "input_shape = ShapeSpec(channels=512)\ntst = FastaiHead(input_shape=input_shape, num_classes=10)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Instantiation">Instantiation<a class="anchor-link" href="#Instantiation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All these modules can we instiated from a config file. Let's take an example ...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">OmegaConf</span><span class="p">,</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">MISSING</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">




<div id="e160ed10-acdc-4993-99aa-dfc2cf3a4ba1"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#e160ed10-acdc-4993-99aa-dfc2cf3a4ba1');

            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "from dataclasses import dataclass, field\nfrom omegaconf import OmegaConf, DictConfig, MISSING";
                var nbb_formatted_code = "from dataclasses import dataclass, field\nfrom omegaconf import OmegaConf, DictConfig, MISSING";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">HeadConf</span><span class="p">:</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MISSING</span>
    <span class="n">act</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ReLU&quot;</span>
    <span class="n">lin_ftrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ps</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">concat_pool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">first_bn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">bn_final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span>
    <span class="n">wd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filter_wd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">structured</span><span class="p">(</span><span class="n">HeadConf</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="n">tst</span> <span class="o">=</span> <span class="n">FastaiHead</span><span class="o">.</span><span class="n">from_config_dict</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FastaiHead(
  (layers): Sequential(
    (0): SelectAdaptivePool2d (pool_type=catavgmax, flatten=True)
    (1): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Dropout(p=0.25, inplace=False)
    (3): Linear(in_features=1024, out_features=512, bias=False)
    (4): ReLU(inplace=True)
    (5): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (6): Dropout(p=0.5, inplace=False)
    (7): Linear(in_features=512, out_features=10, bias=False)
  )
)</pre>
</div>

</div>

<div class="output_area">




<div id="dbea634e-f288-45b3-b80f-00c3a6f55b19"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#dbea634e-f288-45b3-b80f-00c3a6f55b19');

            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "@dataclass\nclass HeadConf:\n    num_classes: int = MISSING\n    act: str = \"ReLU\"\n    lin_ftrs: Optional[List] = None\n    ps: Any = 0.5\n    concat_pool: bool = True\n    first_bn: bool = True\n    bn_final: bool = False\n    lr: float = 0.002\n    wd: float = 0\n    filter_wd: bool = False\n\n\nconf = OmegaConf.structured(HeadConf(num_classes=10))\n\ntst = FastaiHead.from_config_dict(conf, input_shape=input_shape)\ntst";
                var nbb_formatted_code = "@dataclass\nclass HeadConf:\n    num_classes: int = MISSING\n    act: str = \"ReLU\"\n    lin_ftrs: Optional[List] = None\n    ps: Any = 0.5\n    concat_pool: bool = True\n    first_bn: bool = True\n    bn_final: bool = False\n    lr: float = 0.002\n    wd: float = 0\n    filter_wd: bool = False\n\n\nconf = OmegaConf.structured(HeadConf(num_classes=10))\n\ntst = FastaiHead.from_config_dict(conf, input_shape=input_shape)\ntst";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            
</script>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

